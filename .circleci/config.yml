workflows:
  version: 2.1
  node-multi-build:
    jobs:
      - node-v10
      - node-v12:
          run_coveralls: true
      - build_push_docker

version: 2.1
jobs:
  build_push_docker:
    docker:
      - image: circleci/node:10.19.0-buster
    steps: 
    - checkout
    - run:
        name: "Pull Submodules"
        command: |
          git submodule init
          git submodule update --remote
    - setup_remote_docker
    - run:
        name: Build and push docker images
        command: |
          echo ${CIRCLE_BRANCH}
          CIRCLE_BRANCH=${CIRCLE_BRANCH} ./build_and_publish_docker_images.sh
  node-base: &node-base
    working_directory: ~/source-verify
    docker:
    - image: circleci/node
    parameters:
      run_coveralls:
        type: boolean
        default: false
    steps:
    - run:
        name: Versions
        command: npm version
    - checkout
    - restore_cache:
        key: dependency-cache-{{ .Environment.CIRCLE_JOB }}-{{ checksum "package.json" }}
    - run:
        name: install-npm
        command: npm install
    - run:
        name: test
        command: npm run test
    - save_cache:
        key: dependency-cache-{{ .Environment.CIRCLE_JOB }}-{{ checksum "package.json" }}
        paths:
        - ./node_modules

  node-v10:
    <<: *node-base
    docker:
    - image: circleci/node:10
  node-v12:
    <<: *node-base
    docker:
    - image: circleci/node:12
